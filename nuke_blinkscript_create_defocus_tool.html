<!DOCTYPE html>
<html>
<head>
<link rel="Stylesheet" type="text/css" href="style.css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<title>nuke_blinkscript_create_defocus_tool</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<p>
<a href="Index.html">Index</a>
</p>

<div id="[[nuke_index|Nuke Index]]"><h3 id="[[nuke_index|Nuke Index]]" class="header"><a href="#[[nuke_index|Nuke Index]]"><a href="nuke_index.html">Nuke Index</a></a></h3></div>

<div id="[[nuke_blinkscript_index|Nuke - Blinkscript]]"><h3 id="[[nuke_blinkscript_index|Nuke - Blinkscript]]" class="header"><a href="#[[nuke_blinkscript_index|Nuke - Blinkscript]]"><a href="nuke_blinkscript_index.html">Nuke - Blinkscript</a></a></h3></div>

<div id="Create a Custom Defocus Tool Using BlinkScript"><h1 id="Create a Custom Defocus Tool Using BlinkScript" class="header"><a href="#Create a Custom Defocus Tool Using BlinkScript">Create a Custom Defocus Tool Using BlinkScript</a></h1></div>

<ul>
<li>
<a href="https://youtu.be/rMHGSoXj4bw?si=eea6pZgO6jrwqZtA">YouTube Link: Create a Custom Defocus Tool</a>

</ul>
<p>
This is the code from the video:
</p>
<pre cpp>
kernel SimpleDefocusKernel : ImageComputationKernel&lt;ePixelWise&gt;
{
    Image&lt;eRead, eAccessRanged2D, eEdgeClamped&gt; src; // the input image
    Image&lt;eRead, eAccessPoint, eEdgeClamped&gt; defocusMatte;
    Image&lt;eWrite&gt; dst; // the output image
    param:
        // This parameter is made available to the user.
        int defocusSize;
    local:
        // This local variable is not exposed to the user.
    // In define(), parameters can be given labels and default values.
    void define() {
        defineParam(defocusSize, "defocus size", 1);
    }
    // The init() function is run before any calls to process().
    // Local variables can be initialized here.
    void init () {
        src.setRange(-defocusSize, -defocusSize, defocusSize, defocusSize);
    }
    void process() {
    float4 output = 0;
    int normaliser = 0;
    // Sample the defocus matte at the current pixel's coordinates
    float matteValue = defocusMatte().w;
    int scaledDefocusSize = defocusSize * matteValue;
    if (scaledDefocusSize &gt; 0) {
        for(int Y = -scaledDefocusSize; Y &lt;= scaledDefocusSize; Y++) {
            for(int X = -scaledDefocusSize; X &lt;= scaledDefocusSize; X++) {
                if(( scaledDefocusSize - sqrt(pow(X, 2) + pow(Y, 2)) ) &gt; 0) {
                    output += src(X, Y);
                    normaliser += 1;
                }
            }
        }
        if (normaliser &gt; 0) { // Avoid division by zero
            output = output / normaliser;
        } else {
            output = src(0, 0); // Fallback if no samples were taken
        }
        } else {
            output = src(0,0);
        }
        // Write the result to the output image
        dst()= output;
    }
};
</pre>


<p>
I had an error:
</p>
<pre cpp>
kernel: line 65: no viable overloaded '='
</pre>

<p>
Google's Gemini found that the likely issue was not a full set of channels available to 'write into'. Sure enough, I looked at the 'Kernel Parameters' tab, and the 'red' channel for the output was somehow unchecked. Switching it on corrected the issue!
</p>

<table>
<tr>
<td>
NOTE: The non-commercial Nuke on my M3 Mac crashes whenever I tweak anything with this node present.
</td>
</tr>
</table>


<div id="Create a Custom Defocus Tool Using BlinkScript-Line 1"><h3 id="Line 1" class="header"><a href="#Create a Custom Defocus Tool Using BlinkScript-Line 1">Line 1</a></h3></div>

<pre cpp>
kernel SimpleDefocusKernel : ImageComputationKernel&lt;ePixelWise&gt;
</pre>


<div id="Create a Custom Defocus Tool Using BlinkScript-kernel SimpleDefocusKernel → Declares the Kernel Name"><h2 id="kernel SimpleDefocusKernel → Declares the Kernel Name" class="header"><a href="#Create a Custom Defocus Tool Using BlinkScript-kernel SimpleDefocusKernel → Declares the Kernel Name">kernel SimpleDefocusKernel → Declares the Kernel Name</a></h2></div>

<ul>
<li>
The keyword <code>kernel</code> defines the function as a BlinkScript computation kernel.

<li>
<code>SimpleDefocusKernel</code> is the name of the kernel, which can be anything meaningful for your effect.

</ul>
<div id="Create a Custom Defocus Tool Using BlinkScript-ImageComputationKernel&lt;ePixelWise&gt; → Defines the Kernel Type"><h2 id="ImageComputationKernel&lt;ePixelWise&gt; → Defines the Kernel Type" class="header"><a href="#Create a Custom Defocus Tool Using BlinkScript-ImageComputationKernel&lt;ePixelWise&gt; → Defines the Kernel Type">ImageComputationKernel&lt;ePixelWise&gt; → Defines the Kernel Type</a></h2></div>

<ul>
<li>
<code>ImageComputationKernel</code> is a base class that tells BlinkScript this kernel will process an image.

<li>
<code>&lt;ePixelWise&gt;</code> specifies how the computation is applied to pixels.

</ul>
<div id="Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode"><h2 id="&lt;ePixelWise&gt; → Specifies the Processing Mode" class="header"><a href="#Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode">&lt;ePixelWise&gt; → Specifies the Processing Mode</a></h2></div>

<p>
This mode determines how pixels are processed within the kernel:
</p>

<div id="Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Processing Mode Options:"><h4 id="Processing Mode Options:" class="header"><a href="#Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Processing Mode Options:">Processing Mode Options:</a></h4></div>
<ul>
<li>
<code>ePixelWise</code> → Each pixel is processed independently.

<li>
<code>ePointWise</code> → Similar to ePixelWise, but focuses only on exact pixel positions.

<li>
<code>eNeighbourhoodWise</code> → Allows access to neighboring pixels (for blurs, edge detection).

<li>
<code>eGlobalWise</code> → Processes the entire image at once (useful for full-image transformations).

</ul>
<div id="Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Example Usage:"><h4 id="Example Usage:" class="header"><a href="#Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Example Usage:">Example Usage:</a></h4></div>

<p>
If you were writing a kernel for a blur effect that needed access to neighboring pixels, you might use:
</p>
<pre cpp>
kernel BlurKernel : ImageComputationKernel&lt;eNeighbourhoodWise&gt;
</pre>

<p>
If the kernel only modifies one pixel at a time, you’d stick with:
</p>

<pre cpp>
kernel ContrastAdjust : ImageComputationKernel&lt;ePixelWise&gt;
</pre>

<div id="Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Summary"><h4 id="Summary" class="header"><a href="#Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Summary">Summary</a></h4></div>

<table>
<tr>
<td>
<span id="Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Summary-Component"></span><strong id="Component">Component</strong>
</td>
<td>
<span id="Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Summary-Meaning"></span><strong id="Meaning">Meaning</strong>
</td>
</tr>
<tr>
<td>
kernel SimpleDefocusKernel
</td>
<td>
Declares the kernel function &amp; name
</td>
</tr>
<tr>
<td>
ImageComputationKernel
</td>
<td>
Specifies it processes images
</td>
</tr>
<tr>
<td>
&lt;ePixelWise&gt;
</td>
<td>
Defines how pixels are handled
</td>
</tr>
</table>

<pre cpp>
Image&lt;eRead, eAccessRanged2D, eEdgeClamped&gt; src; // the input image
</pre>

<div id="Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Line 3"><h3 id="Line 3" class="header"><a href="#Create a Custom Defocus Tool Using BlinkScript-&lt;ePixelWise&gt; → Specifies the Processing Mode-Line 3">Line 3</a></h3></div>

<pre cpp>
Image&lt;eRead, eAccessRanged2D, eEdgeClamped&gt; src; // the input image
</pre>

<ul>
<li>
<code>eAccessRanged2D</code> --&gt; Allow the BlinkScript to reference surrounding pixels (to the subject pixel) but coords from the subject pixel.

<li>
Because we are using <code>eAccessRanged2D</code>, we  have to declare the 'range' size in the script:

<ul>
<li>
Inside <code>void init() { }</code> we specify the size:

<ul>
<li>
Line 17:

<ul>
<li>
<code>src.setRange(-defocusSize, -defocusSize, defocusSize, defocusSize);</code>

</ul>
</ul>
<li>
Inside <code>param:</code> we declare the variable <code>defocusSize</code>:

<ul>
<li>
Line 8:

<ul>
<li>
<code>int defocusSize;</code>

</ul>
</ul>
<li>
Inside <code>void define() { }</code> we give parameters like the defocusSize parameter a label, and default values:

<ul>
<li>
Line 13:

<ul>
<li>
<code>defineParam(defocusSize, "defocus size", 1);</code> 

</ul>
</ul>
</ul>
</ul>
<p>
<br><br><br>
<a href="nuke_blinkscript_index.html">Nuke - Blinkscript</a>
</p>

<p>
<a href="nuke_index.html">Nuke Index</a>
</p>

<p>
<a href="Index.html">Index</a>
</p>

</body>
</html>
